# Retrotransposon-insert-validation

A set of snakemake rules and scripts for validating the calls generated by the [RTD-Control and RTD-Diploid pipelines](https://github.com/adcosta17/Retrotransposon-insert-detection)

## Dependencies
- pysam
- bgzip
- snakemake
- minimap2
- winnowmap2
- lastal
- samtools
- longshot
- whatshap
- pbsim2

## Overview

This repo contains a set of snakemake rules and scripts that are used to generate the data used in, and evaluate the results of experiments designed to assess the performance of the [RTD-Control and RTD-Diploid pipelines](https://github.com/adcosta17/Retrotransposon-insert-detection). It also contains scripts to generate plots and summarize the results of the experiments.

## Data

We downloaded PacBio Hifi based diploid assemblies and Nanopore reads from the [HPRC](https://github.com/human-pangenomics/HPP_Year1_Data_Freeze_v1.0) for samples: [HG00438](https://s3-us-west-2.amazonaws.com/human-pangenomics/index.html?prefix=working/HPRC/HG00438/), [HG00621](https://s3-us-west-2.amazonaws.com/human-pangenomics/index.html?prefix=working/HPRC/HG00621/), [HG00673](https://s3-us-west-2.amazonaws.com/human-pangenomics/index.html?prefix=working/HPRC/HG00673/), [HG00735](https://s3-us-west-2.amazonaws.com/human-pangenomics/index.html?prefix=working/HPRC/HG00735/), and [HG00741](https://s3-us-west-2.amazonaws.com/human-pangenomics/index.html?prefix=working/HPRC/HG00741/).

## False Positive Rate

To assess the false positive rate of the pipelines the HPRC reads were partitioned into a control and test read sets per sample. The higest coverage read set of the three generated by the HPRC for each sample was noted as the test set while the other two were merged into a control set. 

As the analysis of false positive rate looked at reads of varying read length the reads in each of these sets were optionally split to generate shorter reads. The orignal reads generated by the HPRC were noted as HPRC-Long, while the shorter reads, split into 3 parts HPRC-Medium and split into 5 parts HPRC-Short. The calls below can be used to convert an HPRC-Long read set into an HPRC-Medium or HPRC-Short

```sh
# Generate HPRC-Medium Read set from HPRC-Long reads
python scripts/split_fastq.py --input-fastq <hprc_long.fastq> --splits 3 > <hprc_medium.fastq>

# Generate HPRC-Short Read set from HPRC-Long reads
python scripts/split_fastq.py --input-fastq <hprc_long.fastq> --splits 5 > <hprc_short.fastq>
```

Once fastqs have been generated the RTD-Control and RTD-Diploid pipelines can be run, with the control fastq listed as the control sample for the RTD-Control pipeline and the previoulsy downloaded diploid assembly of the sample used as the personalized diploid assembly for the RTD-Diploid pipeline. The normalized rate of insertion computed using the Effective Bases approach for each pipeline can be compared after the runs are completed to assess the false positive rate. 

## Simulated Somatic Insertions

We used the same HPRC samples to generate simulated somatic insertions and evaulate the RTD-Control and RTD-Diploid pipelines. This evaluation compared the ability of each pipeline to detect simulated somatic insertions using simulated reads generated from the diploid assembly of the sample at varying read lengths. Two read sets were generated per sample and read length, one was a pure simulation of the diploid assembly to act as a control, while the other contained reads that had known simulated somatic retrotransposon insertions. 

The simulated analysis requires the following information be provided in the config files per sample

- ```mat_fa``` and ```pat_fa```: The paths to the maternal and paternal assembly contig sets respectively
- ```pbsim_model```: The path to the pbsim2 module used for the pbsim2 simulation of the reads. Used R94.model for this analysis
- ```chrom_lengths```: The lengths of the GRCh38 chromosomes. Used utils/GRCh38_chromosome_sizes.tsv
- ```run_dir```: The location of where the RTD-Control and RTD-Diploid results will be

We ran the following snakemake rule to generate the read sets 

```
# To generate the data
snakemake -s sim_test.smk --configfile project_config.sim.yaml all_spike_in_bams
```

Once data was generated the two read sets per sample/read-len pair could be used as input for the RTD-Control and Diploid pipelines, with read set 0 used as the control and read set 1 as the test containing simulated insertions. The HPRC diploid assembly was used as the diploid assembly for the RTD-Diploid sample in this evaluation. This may result in an overestimation of precision as the reads are simulated from this assembly. 

After running the pipelines the results can be summarized using the following command. This rule assumes that the pipelines have been run in folders "<run_dir>/<sample>/<read_len>/RTD-Control/" and "<run_dir>/<sample>/<read_len>/RTD-Diplolid/" respectively, with the samples names control and test. 

```
# To summarize the results
snakemake -s sim_test.smk --configfile project_config.sim.yaml all_metrics
```

This will output a file named "simulation_results_{sample}_{read_len}.txt" per sample/read_len pair summarizing the precision and recall


